# 部署指南

本文档将指导您完成点餐小程序的完整部署流程。

## 前置准备

### 1. 必备材料
- [ ] 有效的个体工商户营业执照
- [ ] 食品经营许可证
- [ ] 法定代表人身份证
- [ ] 微信支付商户号（需要单独申请）

### 2. 账号准备
- [ ] 微信小程序账号（个体工商户类型）
- [ ] 微信开放平台账号（可选，用于微信登录）
- [ ] 微信支付商户号

## 第一步：小程序注册与认证

### 1.1 注册小程序
1. 访问 [微信公众平台](https://mp.weixin.qq.com/)
2. 点击"立即注册"
3. 选择"小程序"账号类型
4. 填写账号信息（使用个体工商户信息）
5. 邮箱激活

### 1.2 完成认证
1. 登录小程序后台
2. 进入"设置" -> "基本设置"
3. 点击"微信认证"
4. 支付 300 元认证费用
5. 上传营业执照等材料
6. 等待审核（1-3个工作日）

### 1.3 开通云开发
1. 认证通过后，进入"开发" -> "开发设置"
2. 开通云开发服务
3. 创建云开发环境（建议创建两个：开发环境和生产环境）

## 第二步：项目配置

### 2.1 下载微信开发者工具
1. 访问 [微信开发者工具下载页面](https://developers.weixin.qq.com/miniprogram/dev/devtools/download.html)
2. 下载并安装对应系统版本

### 2.2 导入项目
1. 打开微信开发者工具
2. 点击"导入项目"
3. 选择项目目录：`/Users/jj/Desktop/微信小程序/ptlw_vxxcx`
4. 填写 AppID（从小程序后台获取）
5. 点击"导入"

### 2.3 修改配置文件
1. 打开 `project.config.json`
2. 将 `appid` 字段修改为你的小程序 AppID
3. 保存文件

### 2.4 配置云开发环境
1. 在微信开发者工具中点击"云开发"按钮
2. 选择或创建云环境
3. 复制环境 ID
4. 打开 `cloudbaserc.json`
5. 将 `envId` 字段修改为你的环境 ID

## 第三步：云函数部署

### 3.1 部署所有云函数
1. 在微信开发者工具左侧目录找到 `cloudfunctions` 文件夹
2. 右键点击每个云函数文件夹（createOrder、createPayment、cancelOrder、paymentCallback、initDatabase）
3. 选择"上传并部署：云端安装依赖"
4. 等待部署完成

### 3.2 配置云函数权限
1. 进入云开发控制台
2. 点击"云函数"
3. 为每个云函数配置相应的权限（通常使用默认权限即可）

## 第四步：数据库初始化

### 4.1 创建数据库集合
1. 进入云开发控制台
2. 点击"数据库"
3. 创建以下集合：
   - `categories`（菜品分类）
   - `dishes`（菜品）
   - `orders`（订单）
   - `tables`（桌号）
   - `shopInfo`（店铺信息）

### 4.2 调用初始化函数
1. 在微信开发者工具中，打开调试器
2. 在控制台输入以下代码：
```javascript
wx.cloud.callFunction({
  name: 'initDatabase'
}).then(res => {
  console.log(res)
})
```
3. 查看返回结果，确认初始化成功

### 4.3 验证数据
1. 回到云开发控制台
2. 查看各集合是否已创建示例数据
3. 根据需要修改示例数据

## 第五步：支付配置

### 5.1 申请微信支付
1. 访问 [微信支付商户平台](https://pay.weixin.qq.com/)
2. 注册商户账号
3. 提交审核材料
4. 等待审核通过

### 5.2 关联小程序和商户号
1. 登录小程序后台
2. 进入"功能" -> "微信支付"
3. 关联你的商户号

### 5.3 配置云支付
1. 进入云开发控制台
2. 点击"设置" -> "微信支付配置"
3. 填写商户号和商户密钥
4. 配置支付回调函数为 `paymentCallback`

### 5.4 修改云函数代码
1. 打开 `cloudfunctions/createPayment/index.js`
2. 将 `YOUR_MCH_ID` 替换为你的商户号
3. 保存并重新部署该云函数

## 第六步：图片资源准备

### 6.1 准备图片
根据 `images/README.md` 中的说明准备所有必需的图片。

### 6.2 上传图片到云存储
1. 进入云开发控制台
2. 点击"存储"
3. 点击"上传文件"
4. 批量上传所有图片
5. 记录每个图片的下载地址

### 6.3 更新数据库中的图片地址
1. 在云开发控制台的数据库中
2. 修改 `categories`、`dishes`、`shopInfo` 集合中的图片字段
3. 将占位地址替换为实际的云存储地址

## 第七步：测试

### 7.1 本地测试
1. 在微信开发者工具中点击"编译"
2. 测试所有功能模块：
   - [ ] 首页浏览
   - [ ] 菜品浏览
   - [ ] 加入购物车
   - [ ] 提交订单
   - [ ] 在线支付（使用测试账号）
   - [ ] 订单管理

### 7.2 真机测试
1. 点击"预览"按钮
2. 使用微信扫描二维码
3. 在真机上测试所有功能

### 7.3 多场景测试
- [ ] 不同网络环境（WiFi/4G/5G）
- [ ] 不同手机型号
- [ ] 不同微信版本
- [ ] 并发下单测试

## 第八步：提交审核

### 8.1 检查清单
- [ ] 所有功能测试通过
- [ ] 无明显 Bug
- [ ] 图片资源完整
- [ ] 支付功能正常
- [ ] 数据库数据完整

### 8.2 上传代码
1. 在微信开发者工具中点击"上传"
2. 填写版本号和项目备注
3. 等待上传完成

### 8.3 提交审核
1. 登录小程序后台
2. 进入"版本管理"
3. 选择刚上传的版本
4. 点击"提交审核"
5. 填写审核信息
6. 等待审核（1-7个工作日）

### 8.4 审核通过后
1. 在"版本管理"中点击"发布"
2. 小程序正式上线

## 第九步：上线后配置

### 9.1 生成桌号二维码
1. 为每个桌号生成唯一的二维码
2. 二维码内容格式：`table_number=桌号`
3. 打印二维码并张贴在对应桌位

### 9.2 配置订单通知
1. 在云开发控制台配置订阅消息
2. 设置订单状态变更通知模板
3. 测试通知功能

### 9.3 数据备份
1. 定期备份数据库数据
2. 备份云存储文件
3. 建立数据恢复流程

## 常见问题

### Q1: 云函数部署失败
A: 检查网络连接，确保云开发环境已创建，重试部署。

### Q2: 支付功能无法使用
A: 确认商户号已正确配置，小程序和商户号已关联，云支付已开通。

### Q3: 图片无法显示
A: 检查图片是否已上传到云存储，地址是否正确，存储权限是否设置正确。

### Q4: 订单提交失败
A: 检查云函数是否部署成功，数据库集合是否已创建，网络连接是否正常。

### Q5: 审核被拒绝
A: 查看拒绝原因，常见原因包括：功能不完整、内容违规、缺少必要资质等。

## 维护建议

1. **定期更新**：定期更新菜品信息、价格等
2. **数据备份**：每天备份数据库
3. **监控日志**：定期查看云函数日志，及时发现异常
4. **用户反馈**：收集用户反馈，持续优化体验
5. **安全检查**：定期检查数据安全，防止数据泄露

## 技术支持

如遇到技术问题，可以：
1. 查看微信官方文档
2. 在微信开发者社区提问
3. 查看云函数日志定位问题

## 成本监控

定期查看云开发资源使用情况：
- 云函数调用次数
- 数据库存储空间
- 云存储空间
- 流量使用情况

如接近免费额度上限，考虑升级套餐。