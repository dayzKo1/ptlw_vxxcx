# 云函数部署指南

## 概述

本项目共包含 20 个云函数，涵盖了用户登录、订单管理、菜品管理、收藏管理、地址管理等核心功能。

---

## 云函数列表

### 用户相关
1. `login` - 用户登录/注册
2. `initDatabase` - 初始化数据库

### 订单相关
3. `createOrder` - 创建订单
4. `createPayment` - 创建支付
5. `paymentCallback` - 支付回调
6. `cancelOrder` - 取消订单
7. `updateOrderStatus` - 更新订单状态
8. `completeOrder` - 订单出餐
9. `updateOrderRemark` - 更新订单备注

### 菜品相关
10. `getDishes` - 获取菜品列表
11. `getCategories` - 获取分类列表
12. `getTables` - 获取桌号列表

### 收藏相关
13. `addFavorite` - 添加收藏
14. `removeFavorite` - 取消收藏
15. `getFavorites` - 获取收藏列表

### 地址相关
16. `addAddress` - 添加收货地址
17. `deleteAddress` - 删除收货地址
18. `updateAddress` - 更新收货地址
19. `getAddresses` - 获取收货地址列表
20. `setDefaultAddress` - 设置默认地址

---

## 部署步骤

### 第一步：开通云开发

1. 打开微信开发者工具
2. 点击工具栏"云开发"按钮
3. 按照提示开通云开发服务
4. 选择或创建云开发环境

### 第二步：初始化数据库

1. 部署 `initDatabase` 云函数
   - 右键点击 `cloudfunctions/initDatabase` 文件夹
   - 选择"上传并部署：云端安装依赖"
   - 等待部署完成

2. 运行初始化函数
   - 进入云开发控制台
   - 点击"云函数"
   - 找到 `initDatabase` 函数
   - 点击"测试"按钮
   - 点击"运行测试"
   - 等待初始化完成

3. 验证数据库
   - 进入云开发控制台
   - 点击"数据库"
   - 检查是否创建了以下集合：
     - users
     - orders
     - categories
     - dishes
     - tables
     - favorites
     - addresses
     - shopInfo

### 第三步：部署所有云函数

#### 方法一：逐个部署（推荐）

1. 右键点击 `cloudfunctions/login` 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成
4. 重复以上步骤，部署所有云函数

#### 方法二：批量部署

1. 在云开发控制台
2. 点击"云函数"
3. 点击"批量上传"
4. 选择所有云函数文件夹
5. 点击"上传"

### 第四步：配置数据库权限

1. 进入云开发控制台
2. 点击"数据库"
3. 对每个集合设置权限：

**users**:
- 所有用户可读：否
- 仅创建者可读写：是

**orders**:
- 所有用户可读：否
- 仅创建者可读写：是

**categories**:
- 所有用户可读：是
- 所有用户可写：否

**dishes**:
- 所有用户可读：是
- 所有用户可写：否

**tables**:
- 所有用户可读：是
- 所有用户可写：否

**favorites**:
- 所有用户可读：否
- 仅创建者可读写：是

**addresses**:
- 所有用户可读：否
- 仅创建者可读写：是

**shopInfo**:
- 所有用户可读：是
- 所有用户可写：否

### 第五步：配置支付功能

1. 进入云开发控制台
2. 点击"设置"
3. 点击"支付设置"
4. 按照提示配置微信支付

6. 修改 `createPayment` 云函数
   - 将 `YOUR_MCH_ID` 替换为你的商户号

---

## 测试云函数

### 测试登录功能

1. 在小程序中点击"登录"
2. 授权用户信息
3. 检查数据库 `users` 集合是否新增了用户记录

### 测试订单功能

1. 在菜单页面添加菜品到购物车
2. 进入购物车页面
3. 点击"去结算"
4. 检查数据库 `orders` 集合是否新增了订单记录

### 测试支付功能

1. 在订单页面点击"支付"
2. 完成支付流程
3. 检查订单状态是否更新为"制作中"

---

## 常见问题

### 1. 云函数部署失败

**原因**: 网络问题或依赖安装失败

**解决方法**:
- 检查网络连接
- 重新上传云函数
- 查看云函数日志

### 2. 数据库初始化失败

**原因**: 权限不足或集合已存在

**解决方法**:
- 检查云开发权限
- 删除已存在的集合
- 重新运行初始化函数

### 3. 支付功能无法使用

**原因**: 未配置支付或商户号错误

**解决方法**:
- 在云开发控制台配置支付
- 检查商户号是否正确
- 查看支付回调日志

### 4. 云函数调用超时

**原因**: 云函数执行时间过长

**解决方法**:
- 优化云函数代码
- 增加云函数超时时间
- 使用数据库索引优化查询

---

## 监控与维护

### 查看云函数日志

1. 进入云开发控制台
2. 点击"云函数"
3. 点击云函数名称
4. 点击"日志"标签

### 监控云函数性能

1. 进入云开发控制台
2. 点击"云函数"
3. 点击"监控"标签
4. 查看调用次数、错误率等指标

### 备份数据库

1. 进入云开发控制台
2. 点击"数据库"
3. 点击"备份"
4. 按照提示创建备份

---

## 更新云函数

### 更新单个云函数

1. 修改云函数代码
2. 右键点击云函数文件夹
3. 选择"上传并部署：云端安装依赖"

### 更新所有云函数

1. 修改云函数代码
2. 逐个上传并部署
3. 测试所有功能

---

## 注意事项

1. **云函数超时时间**: 默认为 20 秒，可根据需要调整
2. **云函数内存**: 默认为 256MB，可根据需要调整
3. **数据库读写次数**: 注意免费额度限制
4. **云函数调用次数**: 注意免费额度限制
5. **数据安全**: 定期备份数据，设置合理的权限

---

## 相关文档

- [云函数说明文档](./README.md)
- [数据库集合说明](./DATABASE.md)
- [微信云开发官方文档](https://developers.weixin.qq.com/miniprogram/dev/wxcloud/basis/getting-started.html)
