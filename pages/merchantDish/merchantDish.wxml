<view class="container">
  <view class="header">
    <view class="header-info">
      <text class="header-title">菜品管理</text>
      <text class="header-subtitle">管理店铺菜品信息</text>
    </view>
    <view class="header-actions">
      <button class="order-btn" bindtap="goToOrder">订单管理</button>
    </view>
  </view>

  <view class="tabs">
    <view class="tab-item {{currentTab === 'all' ? 'active' : ''}}" bindtap="switchTab" data-tab="all">全部</view>
    <view class="tab-item {{currentTab === 'online' ? 'active' : ''}}" bindtap="switchTab" data-tab="online">上架中</view>
    <view class="tab-item {{currentTab === 'offline' ? 'active' : ''}}" bindtap="switchTab" data-tab="offline">已下架</view>
  </view>

  <scroll-view class="category-scroll" scroll-x>
    <view class="category-item {{currentCategoryId === '' ? 'active' : ''}}" bindtap="selectCategory" data-id="">全部分类</view>
    <view class="category-item {{currentCategoryId === item._id ? 'active' : ''}}" wx:for="{{categories}}" wx:key="_id" bindtap="selectCategory" data-id="{{item._id}}">{{item.name}}</view>
  </scroll-view>

  <scroll-view class="dish-list" scroll-y enable-back-to-top refresher-enabled refresher-triggered="{{loading}}" bindrefresherrefresh="onPullDownRefresh">
    <view class="dish-item" wx:for="{{dishes}}" wx:key="_id">
      <view class="dish-image" bindtap="showEditModal" data-dish="{{item}}">
        <image src="{{item.image || '/images/default-dish.png'}}" mode="aspectFill"></image>
        <view class="status-badge {{item.status === 1 ? 'online' : 'offline'}}">{{item.statusText}}</view>
      </view>
      <view class="dish-info">
        <view class="dish-name-row">
          <text class="dish-name">{{item.name}}</text>
          <text class="dish-tag hot" wx:if="{{item.isHot}}">热销</text>
          <text class="dish-tag new" wx:if="{{item.isNew}}">新品</text>
        </view>
        <view class="dish-category">{{item.categoryName}}</view>
        <view class="dish-desc">{{item.description || '暂无描述'}}</view>
        <view class="dish-price-row">
          <text class="dish-price">¥{{item.price}}</text>
          <text class="spicy-level" wx:if="{{item.spicyLevel > 0}}">{{['不辣', '微辣', '中辣', '特辣', '变态辣'][item.spicyLevel]}}</text>
        </view>
      </view>
      <view class="dish-actions">
        <button class="action-btn {{item.status === 1 ? 'offline-btn' : 'online-btn'}}" catchtap="toggleStatus" data-id="{{item._id}}" data-status="{{item.status}}">
          {{item.status === 1 ? '下架' : '上架'}}
        </button>
        <button class="action-btn edit-btn" catchtap="showEditModal" data-dish="{{item}}">编辑</button>
        <button class="action-btn delete-btn" catchtap="deleteDish" data-id="{{item._id}}">删除</button>
      </view>
    </view>

    <view class="empty" wx:if="{{dishes.length === 0 && !loading}}">
      <text class="empty-icon">🍽️</text>
      <text class="empty-text">暂无菜品</text>
      <button class="add-first-btn" bindtap="showAddModal">添加菜品</button>
    </view>

    <view class="loading" wx:if="{{loading}}">
      <text class="loading-text">加载中...</text>
    </view>
  </scroll-view>

  <view class="fab" bindtap="showAddModal">
    <text class="fab-icon">+</text>
  </view>
</view>

<view class="modal-mask" wx:if="{{showAddModal || showEditModal}}" bindtap="hideModals"></view>
<view class="modal-container" wx:if="{{showAddModal || showEditModal}}">
  <view class="modal-header">
    <text class="modal-title">{{showAddModal ? '添加菜品' : '编辑菜品'}}</text>
    <text class="modal-close" bindtap="hideModals">×</text>
  </view>
  <scroll-view class="modal-content" scroll-y>
    <view class="form-item">
      <text class="form-label required">菜品名称</text>
      <input class="form-input" placeholder="请输入菜品名称" value="{{formData.name}}" data-field="name" bindinput="onInputChange" />
    </view>
    <view class="form-item">
      <text class="form-label required">菜品价格</text>
      <input class="form-input" type="digit" placeholder="请输入价格" value="{{formData.price}}" data-field="price" bindinput="onInputChange" />
    </view>
    <view class="form-item">
      <text class="form-label">所属分类</text>
      <picker mode="selector" range="{{categories}}" range-key="name" value="{{categoryPickerIndex}}" bindchange="onCategoryChange">
        <view class="form-picker">
          <text>{{categoryPickerName}}</text>
          <text class="picker-arrow">></text>
        </view>
      </picker>
    </view>
    <view class="form-item">
      <text class="form-label">菜品描述</text>
      <textarea class="form-textarea" placeholder="请输入菜品描述" value="{{formData.description}}" data-field="description" bindinput="onInputChange" />
    </view>
    <view class="form-item">
      <text class="form-label">菜品图片</text>
      <view class="image-upload" bindtap="chooseImage">
        <image wx:if="{{formData.image}}" src="{{formData.image}}" mode="aspectFill" class="preview-image"></image>
        <view wx:else class="upload-placeholder">
          <text class="upload-icon">+</text>
          <text class="upload-text">上传图片</text>
        </view>
      </view>
    </view>
    <view class="form-item">
      <text class="form-label">辣度</text>
      <picker mode="selector" range="{{spicyOptions}}" value="{{formData.spicyLevel}}" bindchange="onSpicyChange">
        <view class="form-picker">
          <text>{{spicyOptions[formData.spicyLevel]}}</text>
          <text class="picker-arrow">></text>
        </view>
      </picker>
    </view>
    <view class="form-item">
      <text class="form-label">排序(数字越小越靠前)</text>
      <input class="form-input" type="number" placeholder="0" value="{{formData.sort}}" data-field="sort" bindinput="onInputChange" />
    </view>
    <view class="form-item switch-row">
      <text class="form-label">热销推荐</text>
      <switch checked="{{formData.isHot}}" data-field="isHot" bindchange="onSwitchChange" color="#FF6B6B" />
    </view>
    <view class="form-item switch-row">
      <text class="form-label">新品推荐</text>
      <switch checked="{{formData.isNew}}" data-field="isNew" bindchange="onSwitchChange" color="#FF6B6B" />
    </view>
  </scroll-view>
  <view class="modal-footer">
    <button class="modal-btn cancel" bindtap="hideModals">取消</button>
    <button class="modal-btn confirm" bindtap="submitForm">确定</button>
  </view>
</view>